#!/bin/sh

# load global defaults
. $HOME/etc/config

if test "z$1" == "z"; then
	echo "Date not specified! Aborting."
	exit 1
else
	DATE=$1
fi

if test "z$2" == "z"; then
	echo "Frequency not specified! Aborting."
	exit 1
else
	FREQUENCY=$2
fi

TODO=`ls *.$FREQUENCY | awk -F. '{print $1}'`

if test "z$TODO" == "z"; then
	echo "No files found for specified frequency $FREQUENCY!"
	exit 1
fi

TODIR="$ARCHIVE/$FREQUENCY/$DATE"
if test ! -d "$ARCHIVE/$FREQUENCY"; then
	mkdir $ARCHIVE/$FREQUENCY
fi
if test -d "$TODIR"; then
	echo "Backup directory $TODIR already exists."
	exit 1
else
	mkdir $TODIR
fi

for SERVER in $TODO; do
	# load global defaults
	. $HOME/etc/config

	# load config override file, if it exists
	if test -f "$HOME/etc/$SERVER"; then
		. $HOME/etc/$SERVER
	fi
	COUNT=1
	for LINE in `cat $SERVER.$FREQUENCY`; do
		PART=`echo $LINE | awk -F: '{print $1}'`
		FILE=`echo $LINE | awk -F: '{print $2}'`
		echo $COUNT > /tmp/backup.state
		$SSH -p $SSH_PORT -l $USER $SERVER $TAR "$FILE" $COMPRESS > $TODIR/backup-"$SERVER"-"$PART".tgz
		ERROR=$?
		if test $ERROR -ne 0; then 
			echo "ERROR ON $SERVER $PART"
			exit $ERROR 
                fi
		# this will print an error if the tarfile can't be read
                CONTENTS=`tar ztf $TODIR/backup-"$SERVER"-"$PART".tgz`
                if test -z "$CONTENTS"
                then
                        echo "ERROR ON $SERVER $PART"
                        echo "TARBALL IS EMPTY!"
                        exit 1
                fi
		COUNT=`expr $COUNT + 1`
	done
done
